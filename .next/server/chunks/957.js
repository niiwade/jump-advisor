exports.id=957,exports.ids=[957],exports.modules={6075:(e,t,a)=>{"use strict";a.d(t,{UO:()=>c,Yv:()=>o,pC:()=>i,qj:()=>d});var r=a(94612),n=a(70132),s=a(42374);async function i(e){let t=await n.z.account.findFirst({where:{userId:e,provider:"hubspot"}});if(!t)throw Error("HubSpot account not connected");return r.A.create({baseURL:"https://api.hubapi.com",headers:{Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json"}})}async function o(e,t,a,r,o){try{let c=await i(e),d=await c.post("/crm/v3/objects/contacts",{properties:{email:t,firstname:a,lastname:r}}),l=d.data.id;o&&l&&await c.post("/crm/v3/objects/notes",{properties:{hs_note_body:o,hs_timestamp:Date.now()},associations:[{to:{id:l},types:[{category:"HUBSPOT_DEFINED",typeId:1}]}]});let u=`Email: ${t}

First Name: ${a||""}

Last Name: ${r||""}

Notes: ${o||""}`,m=await (0,s.L)(u),p=await n.z.hubspotContact.create({data:{hubspotId:l,userId:e,email:t,firstName:a||null,lastName:r||null,properties:d.data.properties,embedding:m}});if(o){let e=await (0,s.L)(o);await n.z.hubspotNote.create({data:{hubspotId:`note-${Date.now()}`,contactId:p.id,content:o,embedding:e}})}return(await n.z.instruction.findMany({where:{userId:e,active:!0,instruction:{contains:"contact"}}})).length,{success:!0,contactId:l}}catch(e){return console.error("Error creating HubSpot contact:",e),{success:!1,error:"Failed to create contact"}}}async function c(e){try{let t=await i(e),a=await t.get("/crm/v3/objects/contacts",{params:{limit:100}});if(!a.data.results)return{success:!0,count:0};for(let r of a.data.results){let a=`Email: ${r.properties.email||""}

First Name: ${r.properties.firstname||""}

Last Name: ${r.properties.lastname||""}`,i=await (0,s.L)(a);await n.z.hubspotContact.create({data:{hubspotId:r.id,userId:e,email:r.properties.email||null,firstName:r.properties.firstname||null,lastName:r.properties.lastname||null,properties:r.properties,embedding:i}});try{let e=await t.get(`/crm/v3/objects/contacts/${r.id}/associations/notes`);if(e.data.results)for(let a of e.data.results){let e=a.id,i=(await t.get(`/crm/v3/objects/notes/${e}`)).data.properties.hs_note_body,o=await (0,s.L)(i);await n.z.hubspotNote.create({data:{hubspotId:e,contactId:r.id,content:i,embedding:o}})}}catch(e){console.error(`Error fetching notes for contact ${r.id}:`,e)}}return{success:!0,count:a.data.results.length}}catch(e){return console.error("Error importing HubSpot contacts:",e),{success:!1,error:"Failed to import contacts"}}}async function d(e,t){try{let a=await i(e),r=(await a.get(`/crm/v3/objects/contacts/${t.objectId}`)).data,o=`Email: ${r.properties.email||""}

First Name: ${r.properties.firstname||""}

Last Name: ${r.properties.lastname||""}`,c=await (0,s.L)(o);return await n.z.hubspotContact.create({data:{hubspotId:r.id,userId:e,email:r.properties.email||null,firstName:r.properties.firstname||null,lastName:r.properties.lastname||null,properties:r.properties,embedding:c}}),(await n.z.instruction.findMany({where:{userId:e,active:!0,instruction:{contains:"contact"}}})).length,{success:!0,contactId:r.id}}catch(e){return console.error("Error handling new HubSpot contact:",e),{success:!1,error:"Failed to process new contact"}}}},11572:(e,t,a)=>{"use strict";a.d(t,{AZ:()=>o,Im:()=>i,P2:()=>d,pO:()=>c,xN:()=>l});var r=a(25976),n=a(70132),s=a(42374);async function i(e){let t=await n.z.account.findFirst({where:{userId:e,provider:"google"}});if(!t)throw Error("Google account not connected");let a=new r.q7g.auth.OAuth2(process.env.GOOGLE_CLIENT_ID,process.env.GOOGLE_CLIENT_SECRET);return a.setCredentials({access_token:t.access_token,refresh_token:t.refresh_token}),r.q7g.calendar({version:"v3",auth:a})}async function o(e,t,a,r){try{let n=await i(e),s=await n.freebusy.query({requestBody:{timeMin:t,timeMax:a,items:[{id:"primary"}]}}),o=s.data.calendars?.primary?.busy||[],c=new Date(t||new Date),d=new Date(a||new Date),l=[],u=new Date(c),m=60*r*1e3;for(;u<d;){let e=u.getHours();if(e>=9&&e<17){let e=new Date(u.getTime()+m);!o.some(t=>{let a=new Date(t.start||new Date),r=new Date(t.end||new Date);return u>=a&&u<r||e>a&&e<=r||u<=a&&e>=r})&&e<=d&&l.push({start:u.toISOString(),end:e.toISOString()})}u.setMinutes(u.getMinutes()+30)}return{availableSlots:l}}catch(e){return console.error("Error getting available times:",e),{success:!1,error:"Failed to get available times"}}}async function c(e,t,a="",r,o,d=[]){try{let c=await i(e),l=await c.events.insert({calendarId:"primary",requestBody:{summary:t,description:a,start:{dateTime:r,timeZone:"UTC"},end:{dateTime:o,timeZone:"UTC"},attendees:d.map(e=>({email:e}))},sendUpdates:"all"}),u=`Title: ${t}

Description: ${a}

Attendees: ${d.join(", ")}`,m=await (0,s.L)(u);return await n.z.calendarEvent.create({data:{eventId:l.data.id,userId:e,title:t,description:a,startTime:new Date(r),endTime:new Date(o),attendees:d,embedding:m}}),{success:!0,eventId:l.data.id,htmlLink:l.data.htmlLink}}catch(e){return console.error("Error creating calendar event:",e),{success:!1,error:"Failed to create calendar event"}}}async function d(e){try{let t=await i(e),a=await t.events.list({calendarId:"primary",timeMin:new Date().toISOString(),maxResults:100,singleEvents:!0,orderBy:"startTime"});if(!a.data.items)return{success:!0,count:0};for(let t of a.data.items){if(!t.id)continue;let a=`Title: ${t.summary}

Description: ${t.description||""}

Attendees: ${t.attendees?.map(e=>e.email).join(", ")||""}`,r=await (0,s.L)(a);await n.z.calendarEvent.create({data:{eventId:t.id,userId:e,title:t.summary||"Untitled Event",description:t.description||"",location:t.location||"",startTime:new Date(t.start?.dateTime||t.start?.date||new Date),endTime:new Date(t.end?.dateTime||t.end?.date||new Date),attendees:t.attendees?.map(e=>e.email||"")||[],embedding:r}})}return{success:!0,count:a.data.items.length}}catch(e){return console.error("Error importing calendar events:",e),{success:!1,error:"Failed to import calendar events"}}}async function l(e,t){try{let a=await i(e),r=await a.events.get({calendarId:"primary",eventId:t.eventId}),o=`Title: ${r.data.summary}

Description: ${r.data.description||""}

Attendees: ${r.data.attendees?.map(e=>e.email).join(", ")||""}`,c=await (0,s.L)(o);return await n.z.calendarEvent.create({data:{eventId:r.data.id,userId:e,title:r.data.summary||"Untitled Event",description:r.data.description||"",location:r.data.location||"",startTime:new Date(r.data.start?.dateTime||r.data.start?.date||new Date),endTime:new Date(r.data.end?.dateTime||r.data.end?.date||new Date),attendees:r.data.attendees?.map(e=>e.email||"")||[],embedding:c}}),(await n.z.instruction.findMany({where:{userId:e,active:!0,instruction:{contains:"calendar"}}})).length,{success:!0,eventId:r.data.id}}catch(e){return console.error("Error handling new calendar event:",e),{success:!1,error:"Failed to process new calendar event"}}}},42374:(e,t,a)=>{"use strict";a.d(t,{L:()=>s});let r=new(a(40276)).OpenAI({apiKey:process.env.OPENAI_API_KEY});function n(e){return Math.ceil(e.length/3)}async function s(e){try{let t=4e3>=n(e)?e:(console.log(`Text too long (est. ${n(e)} tokens), truncating to ~4000 tokens`),e.substring(0,12e3));return(await r.embeddings.create({model:"text-embedding-ada-002",input:t})).data[0].embedding}catch(e){throw console.error("Error generating embedding:",e),Error("Failed to generate embedding")}}},61690:(e,t,a)=>{"use strict";a.d(t,{ZM:()=>o,tO:()=>d,wt:()=>i,x4:()=>c});var r=a(25976),n=a(70132),s=a(42374);async function i(e){let t=await n.z.account.findFirst({where:{userId:e,provider:"google"}});if(!t)throw Error("Google account not connected");if(!t.access_token||!t.refresh_token)throw Error("Google OAuth tokens are missing. Please reconnect your Google account.");let a=new r.q7g.auth.OAuth2(process.env.GOOGLE_CLIENT_ID,process.env.GOOGLE_CLIENT_SECRET,process.env.NEXTAUTH_URL?`${process.env.NEXTAUTH_URL}/api/auth/callback/google`:"http://localhost:3000/api/auth/callback/google");return a.setCredentials({access_token:t.access_token,refresh_token:t.refresh_token,expiry_date:t.expires_at?1e3*t.expires_at:void 0}),a.on("tokens",async e=>{console.log("Token refresh occurred"),e.access_token&&await n.z.account.update({where:{id:t.id},data:{access_token:e.access_token,expires_at:e.expiry_date?Math.floor(e.expiry_date/1e3):t.expires_at}})}),r.q7g.gmail({version:"v1",auth:a})}async function o(e,t,a,r){let n=[];if(e||n.push("User ID is required"),t||n.push("Recipient email is required"),t.includes("@")||n.push("Invalid recipient email format"),a||n.push("Email subject is required"),r||n.push("Email body is required"),n.length>0)return console.error("Email validation errors:",n),{success:!1,error:"Validation failed",validationErrors:n,message:"Unable to send email: "+n.join(", ")};try{let n=await i(e),s=[`To: ${t}`,`Subject: ${a}`,"Content-Type: text/html; charset=utf-8","",r].join("\r\n"),o=Buffer.from(s).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),c=await n.users.messages.send({userId:"me",requestBody:{raw:o}});return{success:!0,messageId:c.data.id,message:`Email successfully sent to ${t}`}}catch(t){let e=t instanceof Error?t.message:"Unknown error";return console.error("Error sending email:",t),{success:!1,error:e,message:`Failed to send email: ${e}`}}}async function c(e,t){try{let a,r;console.log(`Starting Gmail import for user ${e}`);try{a=await i(e),console.log("Successfully created Gmail client")}catch(e){return console.error("Gmail authentication error:",e),{success:!1,error:`Gmail authentication failed: ${e instanceof Error?e.message:"Unknown error"}`,count:0}}try{console.log("Fetching Gmail messages..."),r=await a.users.messages.list({userId:"me",maxResults:5}),console.log(`Found ${r.data.messages?.length||0} messages (limited to 5 max)`)}catch(e){return console.error("Gmail API error:",e),{success:!1,error:`Gmail API error: ${e instanceof Error?e.message:"Unknown error"}`,count:0}}if(!r.data.messages)return console.log("No messages found in Gmail"),{success:!0,count:0};let o=r.data.messages.length,c=0,d=0,l=[],u=[];for(let i of r.data.messages){try{let t=await a.users.messages.get({userId:"me",id:i.id}),r=t.data.payload?.headers||[],o=r.find(e=>"Subject"===e.name)?.value||"",d=r.find(e=>"From"===e.name)?.value||"",l=r.find(e=>"To"===e.name)?.value||"",m=r.find(e=>"Date"===e.name)?.value||"",p=function(e){if(!e)return new Date;try{let t=new Date(e);if(!isNaN(t.getTime()))return t;return u.push(`Invalid date format: ${e}, using current date instead`),new Date}catch{return u.push(`Error parsing date: ${e}`),new Date}}(m),g="";if(t.data.payload?.parts)for(let e of t.data.payload.parts)"text/plain"===e.mimeType&&e.body?.data&&(g+=Buffer.from(e.body.data,"base64").toString("utf-8"));else t.data.payload?.body?.data&&(g=Buffer.from(t.data.payload.body.data,"base64").toString("utf-8"));let w=`Subject: ${o}

From: ${d}

Body: ${g}`,f=await (0,s.L)(w);await n.z.emailDocument.upsert({where:{emailId:i.id},update:{subject:o,content:g,sender:d,recipients:[l],sentAt:p,embedding:f,updatedAt:new Date},create:{emailId:i.id,userId:e,subject:o,content:g,sender:d,recipients:[l],sentAt:p,embedding:f}}),c++}catch(e){d++,l.push(`Failed to process email ${i.id}: ${e instanceof Error?e.message:String(e)}`)}t?.onProgress&&await t.onProgress({percentage:Math.round((c+d+0)/o*100),total:o,processed:c,failed:d,skipped:0,errors:l,warnings:u})}return{success:!0,count:c,stats:{totalEmails:o,processedEmails:c,failedEmails:d,skippedEmails:0},errors:l,warnings:u}}catch(e){return console.error("Error importing emails:",e),{success:!1,error:"Failed to import emails",stats:{totalEmails:0,processedEmails:0,failedEmails:0,skippedEmails:0},errors:[e instanceof Error?e.message:String(e)],warnings:[]}}}async function d(e,t){try{let a=await i(e),r=await a.users.messages.get({userId:"me",id:t.emailId}),o=r.data.payload?.headers||[],c=o.find(e=>"Subject"===e.name)?.value||"",d=o.find(e=>"From"===e.name)?.value||"",l=o.find(e=>"To"===e.name)?.value||"",u=o.find(e=>"Date"===e.name)?.value||"",m=function(e){if(!e)return new Date;try{let t=new Date(e);if(!isNaN(t.getTime()))return t;return console.warn(`Invalid date format: ${e}, using current date instead`),new Date}catch(t){return console.warn(`Error parsing date: ${e}`,t),new Date}}(u),p="";if(r.data.payload?.parts)for(let e of r.data.payload.parts)"text/plain"===e.mimeType&&e.body?.data&&(p+=Buffer.from(e.body.data,"base64").toString("utf-8"));else r.data.payload?.body?.data&&(p=Buffer.from(r.data.payload.body.data,"base64").toString("utf-8"));let g=`Subject: ${c}

From: ${d}

Body: ${p}`,w=await (0,s.L)(g);return await n.z.emailDocument.create({data:{emailId:t.emailId,subject:c,userId:e,content:p,sender:d,recipients:[l],sentAt:m,embedding:w}}),(await n.z.instruction.findMany({where:{userId:e,active:!0,instruction:{contains:"email"}}})).length,{success:!0,emailId:t.emailId}}catch(e){return console.error("Error handling new email:",e),{success:!1,error:"Failed to process new email"}}}},70132:(e,t,a)=>{"use strict";a.d(t,{z:()=>n});var r=a(96330);let n=global.prisma||new r.PrismaClient},78335:()=>{},96487:()=>{}};