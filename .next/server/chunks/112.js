"use strict";exports.id=112,exports.ids=[112],exports.modules={94112:(t,e,i)=>{i.d(e,{E:()=>w});var n=i(40276),a=i(70132),r=i(98504),s=i(6075),o=i(61690),c=i(11572),d=i(96330);async function p(t,e,i=.7,n=5){try{return(await (0,r.wz)(t,e,2*n)).results.filter(t=>t.similarity>=i).slice(0,n)}catch(t){return console.error("Error finding potential contacts:",t),[]}}async function l(t,e){try{if(e.includes("@")){let i=await a.z.hubspotContact.findFirst({where:{userId:t,email:e}});if(i)return{isAmbiguous:!1,contacts:[{id:i.id,email:i.email,firstName:i.firstName,lastName:i.lastName,properties:i.properties,similarity:1}],originalQuery:e}}let i=await p(t,e);return{isAmbiguous:i.length>1||1===i.length&&i[0].similarity<.9,contacts:i,originalQuery:e}}catch(t){return console.error("Error checking contact ambiguity:",t),{isAmbiguous:!1,contacts:[],originalQuery:e}}}async function u(t,e,i,n){try{return(await a.z.task.create({data:{userId:t,title:`Disambiguate contact: ${e}`,description:`Please select the correct contact for "${e}"`,type:d.TaskType.GENERAL,status:d.TaskStatus.WAITING_FOR_RESPONSE,metadata:{waitingFor:"Contact selection",waitingSince:new Date().toISOString(),contactReference:e,potentialContacts:i.map(t=>({id:t.id,email:t.email,firstName:t.firstName,lastName:t.lastName,similarity:t.similarity})),context:n}}})).id}catch(t){throw console.error("Error creating disambiguation task:",t),t}}async function m(t,e,i=""){try{let n=await l(t,e);if(!n.isAmbiguous||0===n.contacts.length)return n;let a=await u(t,e,n.contacts,i);return{...n,taskId:a}}catch(t){return console.error("Error handling contact disambiguation:",t),{isAmbiguous:!1,contacts:[],originalQuery:e}}}async function y(t,e){try{let i=await a.z.task.findUnique({where:{id:t,type:d.TaskType.GENERAL}});if(!i)throw Error(`Disambiguation task not found: ${t}`);let n=i.metadata,r=n.potentialContacts.find(t=>t.id===e);if(!r)throw Error(`Selected contact not found in disambiguation options: ${e}`);await a.z.task.update({where:{id:t},data:{status:d.TaskStatus.COMPLETED,completedAt:new Date,metadata:{...n,waitingFor:null,waitingSince:null,selectedContact:{id:r.id,email:r.email,firstName:r.firstName,lastName:r.lastName,similarity:r.similarity},resolvedAt:new Date().toISOString()}}});let s=await a.z.hubspotContact.findUnique({where:{id:e}});if(!s)throw Error(`Contact not found: ${e}`);return{id:s.id,email:s.email,firstName:s.firstName,lastName:s.lastName,properties:s.properties,similarity:r.similarity}}catch(t){return console.error("Error resolving disambiguation:",t),null}}let h=new n.OpenAI({apiKey:process.env.OPENAI_API_KEY}),f=[{type:"function",function:{name:"disambiguate_contact",description:"Check if a contact reference is ambiguous and needs disambiguation",parameters:{type:"object",properties:{contactReference:{type:"string",description:"The contact name, email, or description to check for ambiguity"},context:{type:"string",description:"Additional context about why disambiguation is needed"}},required:["contactReference"]}}},{type:"function",function:{name:"resolve_disambiguation",description:"Resolve a contact disambiguation task with the selected contact",parameters:{type:"object",properties:{taskId:{type:"string",description:"The disambiguation task ID"},selectedContactId:{type:"string",description:"The ID of the selected contact"}},required:["taskId","selectedContactId"]}}},{type:"function",function:{name:"search_emails",description:"Search through user emails for relevant information",parameters:{type:"object",properties:{query:{type:"string",description:"The search query to find relevant emails"},limit:{type:"number",description:"Maximum number of results to return"}},required:["query"]}}},{type:"function",function:{name:"search_contacts",description:"Search through HubSpot contacts for relevant information",parameters:{type:"object",properties:{query:{type:"string",description:"The search query to find relevant contacts"},limit:{type:"number",description:"Maximum number of results to return"}},required:["query"]}}},{type:"function",function:{name:"search_calendar",description:"Search through calendar events for relevant information",parameters:{type:"object",properties:{query:{type:"string",description:"The search query to find relevant calendar events"},startDate:{type:"string",description:"Start date in ISO format"},endDate:{type:"string",description:"End date in ISO format"}},required:["query"]}}},{type:"function",function:{name:"get_available_times",description:"Get available time slots from the user's calendar",parameters:{type:"object",properties:{startDate:{type:"string",description:"Start date in ISO format"},endDate:{type:"string",description:"End date in ISO format"},duration:{type:"number",description:"Duration of the meeting in minutes"}},required:["startDate","endDate","duration"]}}},{type:"function",function:{name:"send_email",description:"Send an email to a recipient",parameters:{type:"object",properties:{to:{type:"string",description:"Email address of the recipient"},subject:{type:"string",description:"Subject of the email"},body:{type:"string",description:"Body content of the email"}},required:["to","subject","body"]}}},{type:"function",function:{name:"create_calendar_event",description:"Create a new calendar event",parameters:{type:"object",properties:{title:{type:"string",description:"Title of the event"},description:{type:"string",description:"Description of the event"},startTime:{type:"string",description:"Start time in ISO format"},endTime:{type:"string",description:"End time in ISO format"},attendees:{type:"array",items:{type:"string"},description:"List of attendee email addresses"}},required:["title","startTime","endTime"]}}},{type:"function",function:{name:"create_hubspot_contact",description:"Create a new contact in HubSpot",parameters:{type:"object",properties:{email:{type:"string",description:"Email address of the contact"},firstName:{type:"string",description:"First name of the contact"},lastName:{type:"string",description:"Last name of the contact"},notes:{type:"string",description:"Additional notes about the contact"}},required:["email"]}}},{type:"function",function:{name:"save_instruction",description:"Save an ongoing instruction from the user",parameters:{type:"object",properties:{instruction:{type:"string",description:"The instruction to save"}},required:["instruction"]}}},{type:"function",function:{name:"get_instructions",description:"Get all active ongoing instructions",parameters:{type:"object",properties:{}}}},{type:"function",function:{name:"create_task",description:"Create a new task for the agent to track",parameters:{type:"object",properties:{title:{type:"string",description:"Title of the task"},description:{type:"string",description:"Description of the task"},type:{type:"string",enum:["EMAIL","CALENDAR","HUBSPOT","GENERAL"],description:"Type of task"},metadata:{type:"object",description:"Additional metadata for the task"}},required:["title","type"]}}},{type:"function",function:{name:"search_contacts",description:"Search through contacts",parameters:{type:"object",properties:{query:{type:"string",description:"The search query"},limit:{type:"number",description:"The maximum number of results to return"}},required:["query"]}}},{type:"function",function:{name:"search_calendar",description:"Search through calendar events",parameters:{type:"object",properties:{query:{type:"string",description:"The search query"},startDate:{type:"string",description:"The start date of the search range"},endDate:{type:"string",description:"The end date of the search range"}},required:["query"]}}},{type:"function",function:{name:"get_available_times",description:"Get available time slots",parameters:{type:"object",properties:{startDate:{type:"string",description:"The start date of the search range"},endDate:{type:"string",description:"The end date of the search range"},duration:{type:"number",description:"The duration of the meeting"}},required:["startDate","endDate","duration"]}}},{type:"function",function:{name:"send_email",description:"Send an email",parameters:{type:"object",properties:{to:{type:"string",description:"The recipient's email address"},subject:{type:"string",description:"The subject of the email"},body:{type:"string",description:"The body of the email"}},required:["to","subject","body"]}}},{type:"function",function:{name:"create_calendar_event",description:"Create a calendar event",parameters:{type:"object",properties:{title:{type:"string",description:"The title of the event"},startTime:{type:"string",description:"The start time of the event"},endTime:{type:"string",description:"The end time of the event"},description:{type:"string",description:"The description of the event"},attendees:{type:"array",items:{type:"string"},description:"The attendees of the event"}},required:["title","startTime","endTime"]}}},{type:"function",function:{name:"create_hubspot_contact",description:"Create a HubSpot contact",parameters:{type:"object",properties:{email:{type:"string",description:"The email address of the contact"},firstName:{type:"string",description:"The first name of the contact"},lastName:{type:"string",description:"The last name of the contact"},company:{type:"string",description:"The company of the contact"},jobTitle:{type:"string",description:"The job title of the contact"}},required:["email"]}}},{type:"function",function:{name:"save_instruction",description:"Save an instruction",parameters:{type:"object",properties:{instruction:{type:"string",description:"The instruction to save"}},required:["instruction"]}}},{type:"function",function:{name:"get_instructions",description:"Get instructions",parameters:{type:"object",properties:{}}}},{type:"function",function:{name:"create_task",description:"Create a task",parameters:{type:"object",properties:{title:{type:"string",description:"The title of the task"},description:{type:"string",description:"The description of the task"},type:{type:"string",enum:["EMAIL","CALENDAR","HUBSPOT","GENERAL"],description:"The type of the task"},metadata:{type:"object",description:"The metadata of the task"}},required:["title","type"]}}}];async function g(t,e){let{name:i,arguments:n}=e.function,d=JSON.parse(n);switch(i){case"disambiguate_contact":return m(t,d.contactReference,d.context||"");case"resolve_disambiguation":return y(d.taskId,d.selectedContactId);case"search_emails":return(0,r.uw)(t,d.query,d.limit||5);case"search_contacts":return(0,r.wz)(t,d.query,d.limit||5);case"search_calendar":return(0,r.og)(t,d.query,d.startDate,d.endDate);case"get_available_times":return(0,c.AZ)(t,d.startDate,d.endDate,d.duration);case"send_email":try{if(!d.to||!d.to.includes("@")){let e=await a.z.task.create({data:{userId:t,title:`Draft email: ${d.subject||"No subject"}`,description:`Draft an email${d.to?" to "+d.to:""} with the following content:

${d.body||"No content provided"}`,type:"EMAIL",status:"PENDING",metadata:{emailDraft:{to:d.to||"",subject:d.subject||"",body:d.body||""},currentStep:1,totalSteps:1}}});return{success:!1,taskCreated:!0,taskId:e.id,message:`I couldn't send the email directly because ${!d.to?"no recipient was specified":"the recipient email address is incomplete"}. I've created a task for you to review and complete the email draft.

**Task Details:**
- **ID:** ${e.id}
- **Title:** ${e.title}
- **Type:** EMAIL
- **Status:** PENDING
- **Content:** ${d.body?d.body.substring(0,100)+(d.body.length>100?"...":""):"No content provided"}

You can find this task in your tasks panel where you can add the recipient details and send it when ready.`}}return(0,o.ZM)(t,d.to,d.subject,d.body)}catch(t){return console.error("Error in send_email tool:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error sending email",message:"I encountered an issue while trying to send your email. Please try again with complete information."}}case"create_calendar_event":return(0,c.pO)(t,d.title,d.startTime,d.endTime,d.description,d.attendees);case"create_hubspot_contact":return(0,s.Yv)(t,d.email,d.firstName,d.lastName);case"save_instruction":return await a.z.instruction.create({data:{userId:t,instruction:d.instruction,active:!0}}),{success:!0,message:"Instruction saved successfully"};case"get_instructions":return{instructions:(await a.z.instruction.findMany({where:{userId:t,active:!0}})).map(t=>t.instruction)};case"create_task":return{success:!0,taskId:(await a.z.task.create({data:{userId:t,title:d.title,description:d.description||"",type:d.type,metadata:d.metadata||{},status:"PENDING"}})).id};default:throw Error(`Unknown tool: ${i}`)}}async function b(t){let e=await a.z.instruction.findMany({where:{userId:t,active:!0}}),i=await a.z.task.findMany({where:{userId:t,status:{in:["PENDING","IN_PROGRESS","WAITING_FOR_RESPONSE"]}}});console.log("DEBUG: Getting disambiguation tasks by title only");let n=await a.z.task.findMany({where:{userId:t,status:d.TaskStatus.WAITING_FOR_RESPONSE,title:{contains:"Disambiguate contact"}}});return{instructions:e.map(t=>t.instruction),pendingTasks:i.map(t=>({id:t.id,title:t.title,description:t.description,status:t.status,type:t.type})),disambiguationTasks:n.length>0?n:void 0}}async function w(t,e,i=[]){try{let n=await b(t),r=e.toLowerCase().includes("draft an email")||e.toLowerCase().includes("write an email"),s=e.includes("@");if(r&&!s){let i=e.match(/(?:to|for)\s+([A-Za-z]+)/i),n=i?i[1]:"",r=e.match(/(?:about|regarding|re:|subject:|on)\s+([^,.]+)/i),s=r?r[1].trim():"discussed topic",o=await a.z.task.create({data:{userId:t,title:`Draft email to ${n||"recipient"}`,description:`Draft an email to ${n||"recipient"} about ${s}`,type:"EMAIL",status:"PENDING",metadata:{emailDraft:{to:n||"",subject:s||"",body:""},currentStep:1,totalSteps:1}}});return`I've created a task to draft an email to ${n||"the recipient"} about ${s}. 

**Task Details:**
- **ID:** ${o.id}
- **Title:** ${o.title}
- **Type:** EMAIL
- **Status:** PENDING

You can find this task in your tasks panel where you can add more details and send it when ready.`}let o=`You are an AI assistant for a financial advisor. You help manage emails, calendar, tasks, and HubSpot contacts.
    
    Current ongoing instructions: ${JSON.stringify(n.instructions)}
    
    Current pending tasks: ${JSON.stringify(n.pendingTasks)}
    ${n.disambiguationTasks?`
    IMPORTANT - You have active contact disambiguation tasks:
    ${JSON.stringify(n.disambiguationTasks.map(t=>{let e=t.metadata||{},i=e.potentialContacts||[];return{id:t.id,title:t.title,contactReference:e.contactReference,potentialContacts:i.map(t=>({id:t.id,name:[t.firstName,t.lastName].filter(Boolean).join(" ")||"Unknown",email:t.email||"No email",similarity:t.similarity}))}}))}
    
    When you see disambiguation tasks, help the user select the correct contact from the options.
    `:""}
    
    Your capabilities:
    1. Search through emails and HubSpot contacts to answer questions about clients
    2. Schedule appointments and manage calendar events
    3. Send emails on behalf of the financial advisor
    4. Create and update contacts in HubSpot
    5. Remember and follow ongoing instructions
    6. Disambiguate contact references when they are ambiguous
    
    When asked about a person and it's ambiguous who the user is referring to:
    1. Use the disambiguate_contact tool to check if disambiguation is needed
    2. If disambiguation is needed, explain to the user that there are multiple potential matches
    3. Present the options clearly with names and emails
    4. Ask the user to select the correct contact
    5. Once selected, use resolve_disambiguation to complete the process
    
    When handling tasks like scheduling appointments, use the appropriate tools to complete the task.
    Always be helpful, professional, and concise in your responses.
    
    When the user asks to draft an email without providing a complete email address, create a task for them instead of attempting to send directly.
    For email drafting requests, if you don't have complete information, create a task and explain what additional information is needed.`,c=[{role:"system",content:o},...i.slice(-10).map(t=>({role:t.role,content:t.content}))],d=(await h.chat.completions.create({model:"gpt-4-turbo",messages:c,tools:f,tool_choice:"auto"})).choices[0].message;if(d.tool_calls&&d.tool_calls.length>0){let e=await Promise.all(d.tool_calls.map(async e=>{let i=await g(t,e);return{tool_call_id:e.id,role:"tool",name:e.function.name,content:JSON.stringify(i)}}));return(await h.chat.completions.create({model:"gpt-4-turbo",messages:[...c,d,...e]})).choices[0].message.content||"I've processed your request."}return d.content||"I'm not sure how to respond to that."}catch(t){return console.error("Error processing user request:",t),"I'm sorry, I encountered an error while processing your request. Please try again."}}},98504:(t,e,i)=>{i.d(e,{Lu:()=>l,og:()=>y,uw:()=>u,wz:()=>m});var n=i(40276),a=i(70132);let r=new n.OpenAI({apiKey:process.env.OPENAI_API_KEY});function s(t,e){if(t.length!==e.length)throw Error(`Vector dimensions don't match: ${t.length} vs ${e.length}`);let i=0,n=0,a=0;for(let r=0;r<t.length;r++)i+=t[r]*e[r],n+=t[r]*t[r],a+=e[r]*e[r];return 0===n||0===a?0:i/(Math.sqrt(n)*Math.sqrt(a))}async function o(t,e,i=5){try{let n=(await a.z.emailDocument.findMany({where:{userId:e},select:{id:!0,subject:!0,content:!0,sender:!0,sentAt:!0,embedding:!0}})).map(e=>{let i=e.embedding,n=s(t,i);return{id:e.id,subject:e.subject,content:e.content,sender:e.sender,sentAt:e.sentAt,similarity:n}});return n.sort((t,e)=>e.similarity-t.similarity),n.slice(0,i)}catch(t){return console.error("Error in findSimilarEmails:",t instanceof Error?t.message:String(t)),[]}}async function c(t,e,i=5){try{let n=(await a.z.hubspotContact.findMany({where:{userId:e},select:{id:!0,email:!0,firstName:!0,lastName:!0,properties:!0,embedding:!0}})).map(e=>{let i=e.embedding,n=s(t,i);return{id:e.id,email:e.email,firstName:e.firstName,lastName:e.lastName,properties:e.properties,similarity:n}});return n.sort((t,e)=>e.similarity-t.similarity),n.slice(0,i)}catch(t){return console.error("Error in findSimilarContacts:",t instanceof Error?t.message:String(t)),[]}}async function d(t,e=5){try{let i=(await a.z.hubspotNote.findMany({select:{id:!0,contactId:!0,content:!0,embedding:!0}})).map(e=>{let i=e.embedding,n=s(t,i);return{id:e.id,contactId:e.contactId,content:e.content,similarity:n}});return i.sort((t,e)=>e.similarity-t.similarity),i.slice(0,e)}catch(t){return console.error("Error in findSimilarNotes:",t instanceof Error?t.message:String(t)),[]}}async function p(t,e,i,n,r=5){try{let o={userId:e};i&&(o.startTime={gte:i}),n&&(o.endTime={lte:n});let c=(await a.z.calendarEvent.findMany({where:o,select:{id:!0,title:!0,description:!0,location:!0,startTime:!0,endTime:!0,attendees:!0,embedding:!0}})).map(e=>{let i=e.embedding,n=s(t,i);return{id:e.id,title:e.title,description:e.description,location:e.location,startTime:e.startTime,endTime:e.endTime,attendees:e.attendees,similarity:n}});return c.sort((t,e)=>e.similarity-t.similarity),c.slice(0,r)}catch(t){return console.error("Error in findSimilarEvents:",t instanceof Error?t.message:String(t)),[]}}async function l(t){return(await r.embeddings.create({model:"text-embedding-ada-002",input:t})).data[0].embedding}async function u(t,e,i=5){try{let n=await l(e);return{results:(await o(n,t,i)).map(t=>({id:t.id,subject:t.subject,content:t.content,sender:t.sender,sentAt:t.sentAt,similarity:Number(t.similarity)}))}}catch(t){return console.error("Error searching emails:",t),{results:[]}}}async function m(t,e,i=5){try{let n=await l(e),r=await c(n,t,i),s=await d(n,i);return{results:await Promise.all(r.map(async t=>{let e=(await a.z.hubspotNote.findMany({where:{contactId:t.id}})).map(t=>{let e=s.find(e=>e.id===t.id);return{id:t.id,content:t.content,createdAt:t.createdAt,similarity:e?Number(e.similarity):0}});return{id:t.id,email:t.email,firstName:t.firstName,lastName:t.lastName,properties:t.properties,similarity:Number(t.similarity),notes:e}}))}}catch(t){return console.error("Error searching contacts:",t),{results:[]}}}async function y(t,e,i,n,a=5){try{let r=await l(e),s=i?new Date(i):void 0,o=n?new Date(n):void 0;return{results:(await p(r,t,s,o,a)).map(t=>({id:t.id,title:t.title,description:t.description,location:t.location,startTime:t.startTime,endTime:t.endTime,attendees:t.attendees,similarity:Number(t.similarity)}))}}catch(t){return console.error("Error searching calendar events:",t),{results:[]}}}}};