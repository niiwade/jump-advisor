"use strict";(()=>{var e={};e.id=669,e.ids=[669],e.modules={1708:e=>{e.exports=require("node:process")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},6111:(e,t,r)=>{r.d(t,{a:()=>c,z:()=>d});var a=r(70132),o=r(11572),i=r(94112);function n(e,t){return e?new Date(e):t?new Date(t):new Date}async function s(e){let t=new(await Promise.resolve().then(r.bind(r,40276))).OpenAI({apiKey:process.env.OPENAI_API_KEY});return(await t.embeddings.create({model:"text-embedding-ada-002",input:e})).data[0].embedding}async function d(e,t,r){try{if(console.log(`Processing calendar update for user ${e}, resource ${t}, state ${r}`),!await a.z.account.findFirst({where:{userId:e,provider:"google"}}))throw Error(`No Google account found for user ${e}`);let i=await (0,o.Im)(e);if("not_exists"===r)return void await u(e,t);let n=await i.events.get({calendarId:"primary",eventId:t});if(!n.data)return void console.log(`No event data found for ${t}`);n.data&&n.data.id&&await c(e,{id:n.data.id,summary:n.data.summary||"",description:n.data.description||"",location:n.data.location||"",start:n.data.start?{dateTime:n.data.start.dateTime||void 0,date:n.data.start.date||void 0}:void 0,end:n.data.end?{dateTime:n.data.end.dateTime||void 0,date:n.data.end.date||void 0}:void 0,attendees:n.data.attendees?.map(e=>({email:e.email||void 0}))||[]}),n.data&&n.data.id&&await p(e,{id:n.data.id,summary:n.data.summary||"",description:n.data.description||"",location:n.data.location||"",start:n.data.start?{dateTime:n.data.start.dateTime||void 0,date:n.data.start.date||void 0}:void 0,end:n.data.end?{dateTime:n.data.end.dateTime||void 0,date:n.data.end.date||void 0}:void 0,attendees:n.data.attendees?.map(e=>({email:e.email||void 0}))||[]})}catch(e){throw console.error("Error processing calendar update:",e),e}}async function c(e,t){try{let{id:r,summary:o="",description:i="",location:d="",start:c,end:u,attendees:p=[]}=t,l=p?.map(e=>e.email||"").filter(Boolean)||[],m=`${o} ${i} ${d} ${l.join(" ")}`,x=await s(m),v=n(c?.dateTime,c?.date),h=n(u?.dateTime,u?.date),w=await a.z.calendarEvent.findFirst({where:{userId:e,eventId:r}});if(w)await a.z.calendarEvent.update({where:{id:w.id},data:{title:o,description:i||"",location:d,startTime:v,endTime:h,attendees:l,embedding:x}}),console.log(`Updated calendar event: ${w.id}`);else{let t=await a.z.calendarEvent.create({data:{userId:e,eventId:r,title:o,description:i||"",location:d,startTime:v,endTime:h,attendees:l,embedding:x}});console.log(`Created calendar event: ${t.id}`)}}catch(e){throw console.error("Error processing calendar event:",e),e}}async function u(e,t){try{await a.z.calendarEvent.deleteMany({where:{userId:e,eventId:t}}),console.log(`Deleted calendar event: ${t}`)}catch(e){throw console.error(`Error handling deleted event ${t}:`,e),e}}async function p(e,t){let r=await a.z.instruction.findMany({where:{userId:e,active:!0,instruction:{contains:"calendar"}}});if(0===r.length)return;let{id:o,summary:n="",description:s="",location:d="",start:c,end:u,attendees:p=[]}=t;for(let t of r)try{let r=`
        I have a calendar event:
        Title: ${n}
        Description: ${s}
        Location: ${d}
        Start: ${c?.dateTime||c?.date||"Not specified"}
        End: ${u?.dateTime||u?.date||"Not specified"}
        Attendees: ${p?.map(e=>e.email||"").filter(Boolean).join(", ")||"None"}
        
        I have the following instruction: "${t.instruction}"
        
        Should I take any action based on this calendar event and instruction? If yes, what action should I take?
      `,l=await (0,i.E)(e,r,[]);l.toLowerCase().includes("yes")&&!l.toLowerCase().includes("no action")&&await a.z.task.create({data:{userId:e,title:`Process calendar event: ${n}`,description:l,type:"EMAIL",status:"PENDING",metadata:{eventId:o,instructionId:t.id}}})}catch(e){console.error(`Error processing instruction for event ${o}:`,e)}}},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{e.exports=require("querystring")},12412:e=>{e.exports=require("assert")},16141:e=>{e.exports=require("node:zlib")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},37067:e=>{e.exports=require("node:http")},37830:e=>{e.exports=require("node:stream/web")},44708:e=>{e.exports=require("node:https")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57075:e=>{e.exports=require("node:stream")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:e=>{e.exports=require("node:fs")},73136:e=>{e.exports=require("node:url")},73496:e=>{e.exports=require("http2")},73565:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>v,routeModule:()=>p,serverHooks:()=>x,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{POST:()=>u});var o=r(96559),i=r(48088),n=r(37719),s=r(32190),d=r(70132),c=r(6111);async function u(e){try{let{resourceId:t,channelId:r,resourceState:a}=await e.json();if(!t||!r)return console.error("Missing required fields in Calendar notification",{resourceId:t,channelId:r}),s.NextResponse.json({error:"Missing required fields"},{status:400});let o=await d.z.webhookSubscription.findFirst({where:{externalId:r,service:"CALENDAR"},include:{user:!0}});if(!o||!o.user)return console.error(`No user found for channel: ${r}`),s.NextResponse.json({error:"User not found"},{status:404});return(0,c.z)(o.user.id,t,a).catch(e=>console.error("Error processing calendar update:",e)),s.NextResponse.json({success:!0})}catch(e){return console.error("Error handling Calendar webhook:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/webhooks/calendar/route",pathname:"/api/webhooks/calendar",filename:"route",bundlePath:"app/api/webhooks/calendar/route"},resolvedPagePath:"C:\\Users\\Joseph\\Documents\\Jump\\jump-advisor\\src\\app\\api\\webhooks\\calendar\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:l,workUnitAsyncStorage:m,serverHooks:x}=p;function v(){return(0,n.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:m})}},73566:e=>{e.exports=require("worker_threads")},74075:e=>{e.exports=require("zlib")},76760:e=>{e.exports=require("node:path")},77030:e=>{e.exports=require("node:net")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},79646:e=>{e.exports=require("child_process")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[243,580,582,957,112],()=>r(73565));module.exports=a})();