"use strict";(()=>{var e={};e.id=783,e.ids=[783],e.modules={1708:e=>{e.exports=require("node:process")},2916:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>b,routeModule:()=>y,serverHooks:()=>v,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>q});var o={};t.r(o),t.d(o,{POST:()=>x});var s=t(96559),a=t(48088),i=t(37719),n=t(32190),u=t(70132),d=t(61690),p=t(98504),c=t(94112);async function l(e,r,t){try{if(console.log(`Processing new email for user ${e} with historyId ${t}`),!await u.z.account.findFirst({where:{userId:e,provider:"google"}}))throw Error(`No Google account found for user ${e}`);let r=await (0,d.wt)(e),o=await m(e),s=await r.users.history.list({userId:"me",startHistoryId:o,historyTypes:["messageAdded"]});if(!s.data.history||0===s.data.history.length){console.log("No new messages found in history"),await w(e,t);return}let a=new Set;for(let e of s.data.history)if(e.messagesAdded)for(let r of e.messagesAdded)r.message?.id&&a.add(r.message.id);for(let t of(console.log(`Found ${a.size} new messages`),a))await f(e,r,t);await w(e,t),await h(e)}catch(e){throw console.error("Error processing new email:",e),e}}async function f(e,r,t){try{let o=await r.users.messages.get({userId:"me",id:t,format:"full"}),s=o.data.payload?.headers||[],a=s.find(e=>"Subject"===e.name)?.value||"",i=s.find(e=>"From"===e.name)?.value||"",n=s.find(e=>"To"===e.name)?.value||"",d=s.find(e=>"Date"===e.name)?.value||"",c="";if(o.data.payload?.parts)for(let e of o.data.payload.parts)"text/plain"===e.mimeType&&e.body?.data&&(c+=Buffer.from(e.body.data,"base64").toString("utf-8"));else o.data.payload?.body?.data&&(c=Buffer.from(o.data.payload.body.data,"base64").toString("utf-8"));let l=`Subject: ${a}
From: ${i}

${c}`,f=await (0,p.Lu)(l),m=await u.z.emailDocument.create({data:{userId:e,messageId:t,subject:a,sender:i,recipient:n,content:c,sentAt:new Date(d),embedding:f}});console.log(`Stored email: ${m.id}`)}catch(e){throw console.error(`Error processing message ${t}:`,e),e}}async function m(e){let r=await u.z.syncState.findUnique({where:{userId_service:{userId:e,service:"GMAIL"}}});return r?.lastSyncToken||"1"}async function w(e,r){await u.z.syncState.upsert({where:{userId_service:{userId:e,service:"GMAIL"}},update:{lastSyncToken:r,lastSyncAt:new Date},create:{userId:e,service:"GMAIL",lastSyncToken:r,lastSyncAt:new Date}})}async function h(e){let r=await u.z.instruction.findMany({where:{userId:e,active:!0}});if(0!==r.length)for(let t of(await u.z.emailDocument.findMany({where:{userId:e,processed:!1},orderBy:{sentAt:"desc"},take:10})))for(let o of r)try{let r=`
          I have a new email:
          From: ${t.sender}
          Subject: ${t.subject}
          Content: ${t.content.substring(0,500)}...
          
          I have the following instruction: "${o.instruction}"
          
          Should I take any action based on this email and instruction? If yes, what action should I take?
        `,s=await (0,c.E)(e,r,[]);s.toLowerCase().includes("yes")&&!s.toLowerCase().includes("no action")&&await u.z.task.create({data:{userId:e,title:`Process email: ${t.subject}`,description:s,type:"EMAIL",status:"PENDING",metadata:{emailId:t.id,instructionId:o.id}}}),await u.z.emailDocument.update({where:{id:t.id},data:{processed:!0}})}catch(e){console.error(`Error processing instruction for email ${t.id}:`,e)}}async function x(e){try{let{emailAddress:r,historyId:t}=await e.json();if(!r||!t)return console.error("Missing required fields in Gmail notification",{emailAddress:r,historyId:t}),n.NextResponse.json({error:"Missing required fields"},{status:400});let o=await u.z.account.findFirst({where:{provider:"google",providerAccountId:r},include:{user:!0}});if(!o?.user)return console.error(`No user found for email: ${r}`),n.NextResponse.json({error:"User not found"},{status:404});return l(o.user.id,r,t).catch(e=>console.error("Error processing new email:",e)),n.NextResponse.json({success:!0})}catch(e){return console.error("Error handling Gmail webhook:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let y=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/webhooks/gmail/route",pathname:"/api/webhooks/gmail",filename:"route",bundlePath:"app/api/webhooks/gmail/route"},resolvedPagePath:"C:\\Users\\Joseph\\Documents\\Jump\\jump-advisor\\src\\app\\api\\webhooks\\gmail\\route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:g,workUnitAsyncStorage:q,serverHooks:v}=y;function b(){return(0,i.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:q})}},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{e.exports=require("querystring")},12412:e=>{e.exports=require("assert")},16141:e=>{e.exports=require("node:zlib")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},37067:e=>{e.exports=require("node:http")},37830:e=>{e.exports=require("node:stream/web")},44708:e=>{e.exports=require("node:https")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57075:e=>{e.exports=require("node:stream")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:e=>{e.exports=require("node:fs")},73136:e=>{e.exports=require("node:url")},73496:e=>{e.exports=require("http2")},73566:e=>{e.exports=require("worker_threads")},74075:e=>{e.exports=require("zlib")},76760:e=>{e.exports=require("node:path")},77030:e=>{e.exports=require("node:net")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},79646:e=>{e.exports=require("child_process")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[243,580,582,957,112],()=>t(2916));module.exports=o})();